# AI旅行规划助手 - 模型调用接口文档

## 1. 概述
本文档详细描述了AI旅行规划助手系统中模型调用相关的接口实现细节，包括后端服务如何调用阿里云百炼模型服务生成行程计划。

## 2. 模型调用服务实现

### 2.1 服务类：BaiLianService

#### 功能说明
`BaiLianService`是负责与阿里云百炼模型服务交互的核心服务类，使用OpenAI Java SDK v2.6.0进行模型调用。

#### 依赖配置
服务需要以下配置参数（从Spring配置文件中读取）：
- `aliyun.bailian.api-key`: 阿里云百炼API密钥
- `aliyun.bailian.api-url`: 阿里云百炼API端点URL

#### 核心方法

```java
public String generateTravelPlan(String userRequest) {
    // 实现模型调用逻辑
    // 返回AI生成的行程计划JSON字符串
}
```

## 3. 模型调用详细参数

### 3.1 模型信息
- **模型名称**: `qwen-plus` (阿里云通义千问大模型)
- **API调用方式**: 基于OpenAI兼容接口

### 3.2 请求参数构建

```java
ChatCompletionCreateParams params = ChatCompletionCreateParams.builder()
        .addSystemMessage("你是一个专业的旅游规划助手，擅长根据用户需求制定详细的旅游行程计划。")
        .addUserMessage(prompt)
        .model("qwen-plus")
        .build();
```

### 3.3 提示词设计

系统构建了结构化的提示词，确保AI返回格式统一的JSON数据：

```
请根据用户的旅游要求，生成一个详细的旅游行程计划。
注意以下要求：
1. 每天的旅游计划从目标城市的酒店开始
2. 在每一个场景（景点、餐厅等）之间必须穿插交通安排
3. 每一天中的行程安排必须严格按照时间顺序排列
请按照以下JSON格式返回，确保格式正确且可被解析：
{
  "totalDays": 3,
  "totalPeople": 2,
  "totalBudget": 3000.00,
  "accommodationBudget": 1000.00,
  "diningBudget": 800.00,
  "transportationBudget": 600.00,
  "attractionsBudget": 400.00,
  "shoppingBudget": 200.00,
  "schedules": [
    {
      "day": 1,
      "type": "ACCOMMODATION", // 可选值: ACCOMMODATION, DINING, TRANSPORTATION, TICKET, SHOPPING
      "startTime": "2023-07-15T14:00:00",
      "endTime": "2023-07-16T12:00:00",
      "cost": 300.00,
      "location": "某酒店",
      "description": "舒适的双人房"
    }
  ]
}
用户的旅游要求是：[用户输入内容]
```

## 4. 生成的响应格式

### 4.1 返回JSON结构

AI模型返回的JSON数据包含以下字段：

| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `totalDays` | Integer | 旅行总天数 |
| `totalPeople` | Integer | 出行人数 |
| `totalBudget` | Double | 总预算金额 |
| `accommodationBudget` | Double | 住宿预算 |
| `diningBudget` | Double | 餐饮预算 |
| `transportationBudget` | Double | 交通预算 |
| `attractionsBudget` | Double | 景点门票预算 |
| `shoppingBudget` | Double | 购物预算 |
| `schedules` | Array | 详细行程安排数组 |

### 4.2 行程安排(schedules)对象结构

每个行程安排对象包含：

| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `day` | Integer | 第几天的行程 |
| `type` | String | 行程类型(ACCOMMODATION, DINING, TRANSPORTATION, TICKET, SHOPPING) |
| `startTime` | String | 开始时间(ISO格式) |
| `endTime` | String | 结束时间(ISO格式) |
| `cost` | Double | 费用金额 |
| `location` | String | 地点名称 |
| `description` | String | 详细描述 |

## 5. 错误处理机制

服务实现了完善的错误处理机制：

### 5.1 可能的错误情况

1. **API调用超时**
2. **API密钥无效**
3. **AI响应格式错误**
4. **网络连接异常**

### 5.2 日志记录

系统使用SLF4J记录详细的日志信息：
- 调用前记录用户请求内容
- 调用过程记录关键步骤
- 成功时记录响应内容长度
- 失败时记录详细错误信息

### 5.3 异常抛出

所有异常都会被封装为`RuntimeException`并抛出，错误消息包含原始错误信息。

```java
throw new RuntimeException("Failed to generate travel plan: " + e.getMessage(), e);
```

## 6. 与Controller层交互

`BaiLianService`被`AIGeneratedTravelPlanController`调用，处理流程如下：

1. Controller接收用户请求
2. 调用`baiLianService.generateTravelPlan()`获取AI生成的行程计划
3. 使用`TravelPlanParser`解析返回的JSON数据
4. 将解析后的数据保存到数据库
5. 构建响应对象并返回给前端

## 7. 接口文档参考

完整的HTTP API接口文档请参考：
- **AI生成行程计划接口**: `/api/ai/generate-travel-plan`
- **AI API连接测试接口**: `/api/ai/test`

## 8. 调用流程图

```
+----------------+      +----------------+      +----------------+
|                |      |                |      |                |
|  用户请求      |----->|  Controller    |----->|  BaiLianService|
|                |      |                |      |                |
+----------------+      +----------------+      +-------+--------+
                                                       |
                                                       v
                                               +----------------+
                                               |                |
                                               |  阿里云百炼    |
                                               |  模型服务      |
                                               |                |
                                               +-------+--------+
                                                       |
                                                       v
                                               +----------------+
                                               |                |
                                               |  解析和存储    |
                                               |  行程计划      |
                                               |                |
                                               +----------------+
```

## 9. 性能优化建议

1. **增加缓存机制**: 对于相似的用户请求，可以考虑缓存生成的行程计划
2. **异步处理**: 对于复杂的行程生成请求，可以改为异步处理模式
3. **请求限流**: 实现API调用限流，避免频繁请求导致的API配额耗尽
4. **超时控制**: 为API调用设置合理的超时时间

## 10. 安全注意事项

1. 确保API密钥安全存储，避免硬编码
2. 对用户输入进行验证和过滤，防止提示词注入攻击
3. 实现请求频率限制，防止恶意调用
4. 记录详细的操作日志，便于审计和问题排查